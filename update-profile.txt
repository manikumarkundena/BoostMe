=====login.js======
document.addEventListener("DOMContentLoaded", () => {
    
    // ELEMENTS
    const authBtn = document.getElementById("authBtn");
    const toggleLink = document.getElementById("toggleLink");
    const nameGroup = document.getElementById("nameGroup");
    const pageTitle = document.getElementById("pageTitle");
    const alertBox = document.getElementById("alertBox");
    
    // Avatar Elements
    const avatarSection = document.getElementById("avatarSection");
    const avatarImg = document.getElementById("avatarImg");
    const shuffleBtn = document.getElementById("shuffleBtn");
    
    // Inputs
    const emailInput = document.getElementById("emailInput");
    const passInput = document.getElementById("passwordInput");
    const nameInput = document.getElementById("nameInput");

    let isSignUp = false; 
    let currentAvatarUrl = "https://api.dicebear.com/7.x/notionists/svg?seed=Felix"; // Default

    // --- AVATAR LOGIC ---
    function updateAvatar(seed) {
        // We use 'notionists' style because it fits your app aesthetic perfectly
        currentAvatarUrl = `https://api.dicebear.com/7.x/notionists/svg?seed=${seed}&backgroundColor=e1e4e8,ffd5dc,c0aede`;
        avatarImg.src = currentAvatarUrl;
    }

    // 1. Auto-generate when typing name
    nameInput.addEventListener("input", (e) => {
        if(e.target.value.length > 0) updateAvatar(e.target.value);
    });

    // 2. Manual Shuffle
    shuffleBtn.addEventListener("click", () => {
        const randomSeed = Math.random().toString(36).substring(7);
        updateAvatar(randomSeed);
        // If they haven't typed a name yet, keep this seed in mind? 
        // Actually, name input override is fine.
    });

    // --- TOGGLE LOGIC ---
    toggleLink.addEventListener("click", () => {
        isSignUp = !isSignUp;
        alertBox.style.display = "none"; 
        
        if (isSignUp) {
            // SHOW AVATAR & NAME
            nameGroup.style.display = "block";
            avatarSection.style.display = "flex"; // Show Avatar
            pageTitle.innerText = "Create Account";
            authBtn.innerText = "Sign Up";
            toggleLink.innerText = "Login";
            document.getElementById("toggleText").innerHTML = 'Already have an account? <span id="toggleLink" class="link">Login</span>';
            // Re-bind listener (since innerHTML replaced element)
            document.getElementById("toggleLink").addEventListener("click", arguments.callee);
        } else {
            // HIDE AVATAR & NAME
            nameGroup.style.display = "none";
            avatarSection.style.display = "none"; // Hide Avatar
            pageTitle.innerText = "Welcome Back";
            authBtn.innerText = "Login";
            toggleLink.innerText = "Sign Up";
            document.getElementById("toggleText").innerHTML = 'Don\'t have an account? <span id="toggleLink" class="link">Sign Up</span>';
            document.getElementById("toggleLink").addEventListener("click", arguments.callee);
        }
    });

    // --- AUTH SUBMIT ---
    authBtn.addEventListener("click", async () => {
        const email = emailInput.value.trim();
        const password = passInput.value.trim();
        const name = nameInput.value.trim();

        if (!email || !password) return showAlert("Please fill in all fields.");
        if (isSignUp && !name) return showAlert("Please enter your name.");
        if (password.length < 6) return showAlert("Password too short (min 6 chars).");

        // UI Loading
        const originalText = authBtn.innerText;
        authBtn.innerHTML = `<i data-lucide="loader-2" class="spin"></i> Processing...`;
        authBtn.disabled = true;
        lucide.createIcons();

        try {
            let data, error;

            if (isSignUp) {
                // === SIGN UP ===
                const result = await sb.auth.signUp({
                    email: email,
                    password: password,
                    options: {
                        data: { 
                            display_name: name,
                            avatar_url: currentAvatarUrl // üëà SAVING THE AVATAR HERE
                        }
                    }
                });
                data = result.data;
                error = result.error;

                if (!error && data.user) {
                    // Create DB Stats Entry
                    await sb.from('user_stats').insert([{ id: data.user.id }]);
                    
                    // (Optional) Save to 'profiles' table if you created one
                    await sb.from('profiles').insert([{
                        id: data.user.id,
                        display_name: name,
                        avatar_url: currentAvatarUrl
                    }]);

                    alert("‚úÖ Account Created! Logging in...");
                    window.location.href = "home.html";
                    return;
                }

            } else {
                // === LOGIN ===
                const result = await sb.auth.signInWithPassword({
                    email: email,
                    password: password
                });
                data = result.data;
                error = result.error;

                if (!error && data.user) {
                    window.location.href = "home.html";
                    return;
                }
            }

            if (error) showAlert("‚ö†Ô∏è " + error.message);

        } catch (err) {
            showAlert("Error: " + err.message);
        } finally {
            authBtn.innerText = originalText;
            authBtn.disabled = false;
        }
    });

    function showAlert(msg) {
        alertBox.innerText = msg;
        alertBox.style.display = "block";
    }

    // Password Eye Toggle
    document.getElementById("togglePass").addEventListener("click", (e) => {
        const type = passInput.getAttribute("type") === "password" ? "text" : "password";
        passInput.setAttribute("type", type);
        e.currentTarget.innerHTML = type === "password" ? `<i data-lucide="eye"></i>` : `<i data-lucide="eye-off"></i>`;
        lucide.createIcons();
    });
});\n\n=====login.html====\n\n
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BoostMe ‚Äì Access</title>
    <link rel="stylesheet" href="../styles/global.css">
    <link rel="stylesheet" href="../styles/login.css">
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>
<body>

    <div class="bg-orb orb-1"></div>
    <div class="bg-orb orb-2"></div>

    <div class="login-container">
        <div class="login-card">
            
            <div class="login-header">
                <img src="../assets/images/boostme-logo.png" class="login-logo" alt="Logo">
                <h1 id="pageTitle">Welcome Back</h1>
                <p id="pageSub">Enter your credentials to access your focus stats.</p>
            </div>

            <div id="alertBox" class="alert-box" style="display:none;"></div>

            <div class="login-form">
                <div id="avatarSection" class="avatar-wrapper" style="display:none;">
    <div class="avatar-preview">
        <img id="avatarImg" src="https://api.dicebear.com/7.x/notionists/svg?seed=Felix" alt="Avatar">
    </div>
    <button id="shuffleBtn" class="secondary-btn small-btn" type="button">
        <i data-lucide="refresh-cw"></i> Shuffle
    </button>
</div>
                
                <div class="input-group" id="nameGroup" style="display:none;">
                    <i data-lucide="user" class="input-icon"></i>
                    <input type="text" id="nameInput" placeholder="Full Name">
                </div>

                <div class="input-group">
                    <i data-lucide="mail" class="input-icon"></i>
                    <input type="email" id="emailInput" placeholder="name@example.com">
                </div>

                <div class="input-group">
                    <i data-lucide="lock" class="input-icon"></i>
                    <input type="password" id="passwordInput" placeholder="Password">
                    <button id="togglePass" class="eye-btn"><i data-lucide="eye"></i></button>
                </div>

                <button id="authBtn" class="primary-btn full-width">
                    Login
                </button>
            </div>

            <div class="login-footer">
                <p id="toggleText">Don't have an account? <span id="toggleLink" class="link">Sign Up</span></p>
                <a href="home.html" class="back-link">
                    <i data-lucide="arrow-left" width="16"></i> Back to Home
                </a>
            </div>

        </div>
    </div>

    <script src="../scripts/supabase.js"></script>
    <script src="../scripts/login.js"></script>
    <script>lucide.createIcons();</script>

</body>
</html>\n\n=====settings.html====\n\n
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>BoostMe Settings</title>

    <link rel="stylesheet" href="../styles/global.css">
    <link rel="stylesheet" href="../styles/settings.css">

    <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
</head>

<body>

<header class="top-bar">
    <div class="top-left">
        <img src="../assets/images/boostme-logo.png" class="top-logo">
        <div>
            <div class="top-app-name">BoostMe</div>
            <div class="top-subtext">Settings</div>
        </div>
    </div>
</header>

<main class="settings-container">

    <h2 class="settings-title">App Settings ‚öôÔ∏è</h2>

    <div class="settings-card glass-panel">
        <h3>Theme</h3>
        <button onclick="toggleTheme()" class="primary-btn full">Toggle Dark / Light</button>
    </div>

    <div class="settings-card glass-panel">
        <h3>Edit Profile</h3>
        <a href="avatar.html" class="primary-btn full">Change Avatar</a>
    </div>

    <div class="settings-card glass-panel danger">
        <h3>Logout</h3>
        <button onclick="logout()" class="danger-btn full">Logout</button>
    </div>

</main>

<script>
async function logout() {
    await sb.auth.signOut();
    window.location.href = "home.html";
}
</script>

<script src="../scripts/supabase.js"></script>

</body>
</html>
\n\n=====supabase.js=====\n\n
// ================================
//  SUPABASE CLIENT SETUP
// ================================
const SUPABASE_URL = "https://iygvxqkzdpmelgzggvio.supabase.co"; // your URL
const SUPABASE_KEY = "sb_publishable_kvcj_5TVeYRkxujDoG8lhw_OcZRbPYz";
// anon key only

const { createClient } = supabase;
const sb = createClient(SUPABASE_URL, SUPABASE_KEY);

window.sb = sb; // so other scripts can use sb
let currentUser = null;
window.currentUser = null;

// ================================
//  1) AUTH MODAL (MAGIC LINK LOGIN)
// ================================
function openAuth() {
    const modal = document.getElementById("authModal");
    if (modal) {
        modal.style.display = "flex";
        setTimeout(() => modal.classList.add("active"), 10);
    }
}

function closeAuth() {
    const modal = document.getElementById("authModal");
    if (modal) {
        modal.classList.remove("active");
        setTimeout(() => (modal.style.display = "none"), 300);
    }
}

async function handleMagicLogin() {
    const emailEl = document.getElementById("emailInput");
    if (!emailEl) return;

    const email = emailEl.value.trim();
    if (!email.includes("@")) {
        alert("Please enter a valid email!");
        return;
    }

    const btn = document.querySelector(".magic-btn");
    if (!btn) return;

    const originalText = btn.innerText;
    btn.innerText = "‚ú® Sending...";
    btn.disabled = true;

    const { error } = await sb.auth.signInWithOtp({
        email,
        options: { emailRedirectTo: window.location.href }
    });

    if (error) {
        alert("Error: " + error.message);
        btn.innerText = originalText;
        btn.disabled = false;
    } else {
        btn.innerHTML = "‚úÖ Check your Inbox!";
        setTimeout(() => {
            closeAuth();
            alert("We sent a magic link to " + email + ". Click it to login!");
        }, 1500);
    }
}

// Expose these globally
window.openAuth = openAuth;
window.closeAuth = closeAuth;
window.handleMagicLogin = handleMagicLogin;

// ================================
//  2) USER + HEADER UI HANDLING
// ================================
async function ensureProfileRow(user) {
    if (!user) return;
    const { data, error } = await sb
        .from("profiles")
        .select("id")
        .eq("id", user.id)
        .single();

    if (error && error.code !== "PGRST116") {
        console.log("Profile fetch error:", error);
        return;
    }

    if (!data) {
        await sb.from("profiles").insert({
            id: user.id,
            email: user.email,
            full_name: user.user_metadata?.full_name || null,
            avatar_url:
                user.user_metadata?.avatar_url ||
                `https://api.dicebear.com/7.x/notionists/svg?seed=${encodeURIComponent(
                    user.email || "BoostUser"
                )}`
        });
    }
}

// Called on page load & on auth state change
async function checkUser() {
    const {
        data: { session }
    } = await sb.auth.getSession();
    currentUser = session?.user || null;
    window.currentUser = currentUser;

    const loginBtn = document.getElementById("loginBtn");
    const profileWrapper = document.getElementById("profileDropdown");
    const profileAvatar = document.getElementById("profileAvatar");
    const authArea = document.getElementById("authArea");

    if (currentUser) {
        await ensureProfileRow(currentUser);
        // Avatar from auth metadata or default
        const meta = currentUser.user_metadata || {};
        const avatarUrl =
            meta.avatar_url ||
            `https://api.dicebear.com/7.x/notionists/svg?seed=${encodeURIComponent(
                currentUser.email || "BoostUser"
            )}`;

        // Top-right login/profile
        if (loginBtn) loginBtn.style.display = "none";
        if (profileWrapper) profileWrapper.style.display = "flex";
        if (profileAvatar) profileAvatar.src = avatarUrl;

        // Optional generic auth area
        if (authArea) {
            authArea.innerHTML = `
                <div class="profile-wrapper" id="profileDropdown">
                    <img src="${avatarUrl}" class="profile-avatar" id="profileBtn">
                    <div class="profile-menu" id="profileMenu">
                        <button onclick="openProfile()">View Profile</button>
                        <button onclick="changeAvatar()">Change Avatar</button>
                        <button onclick="openSettings()">Settings</button>
                        <button onclick="logout()">Logout</button>
                    </div>
                </div>
            `;
            const profileBtn = document.getElementById("profileBtn");
            const profileMenu = document.getElementById("profileMenu");
            if (profileBtn && profileMenu) {
                profileBtn.onclick = () => {
                    profileMenu.classList.toggle("show");
                };
            }
        }
    } else {
        // Not logged in
        if (loginBtn) loginBtn.style.display = "flex";
        if (profileWrapper) profileWrapper.style.display = "none";

        if (authArea) {
            authArea.innerHTML = `
                <a href="login.html" class="primary-btn" style="padding:8px 16px;">Login</a>
            `;
        }
    }
}

// Listen for auth changes & re-run checkUser
sb.auth.onAuthStateChange((_event, _session) => {
    checkUser();
});

// Run on first load
document.addEventListener("DOMContentLoaded", checkUser);

// ================================
//  3) DASHBOARD / CLOUD STATS
// ================================
async function syncDailyStats() {
    if (!currentUser) return;
    
    // FIX: Use Local Time so stats don't save to "yesterday" if it's late at night
    const today = new Date().toLocaleDateString('en-CA');

    let { data, error } = await sb
        .from("daily_stats")
        .select("*")
        .eq("user_id", currentUser.id)
        .eq("date", today)
        .single();

    if (error && error.code !== "PGRST116") {
        console.log("daily_stats fetch error:", error);
        return;
    }

    if (!data) {
        await sb.from("daily_stats").insert([
            {
                user_id: currentUser.id,
                date: today,
                focus_minutes: 0,
                completed_tasks: 0,
                chats: 0,
                mood_score: null
            }
        ]);
    } else {
        console.log("Cloud daily_stats:", data);
    }
}

// Call this from focus.js when a focus session completes
async function saveDailyStats({
  focusMinutes = 0,
  challengeMinutes = 0,
  gamesPlayed = 0,
  completedTasks = 0,
  chats = 0,
  challengesCompleted = 0,
  moodScore = null
}) {
  if (!currentUser) return;
  
  // FIX: Use Local Time here too
  const today = new Date().toLocaleDateString('en-CA');

  const { data, error } = await sb
    .from("daily_stats")
    .select("*")
    .eq("user_id", currentUser.id)
    .eq("date", today)
    .maybeSingle();

  if (error) {
    console.error("‚ùå daily_stats fetch error:", error);
    return;
  }

  const updated = {
    user_id: currentUser.id,
    date: today,
    focus_minutes: (data?.focus_minutes || 0) + focusMinutes,
    challenge_minutes: (data?.challenge_minutes || 0) + challengeMinutes,
    games_played: (data?.games_played || 0) + gamesPlayed,
    completed_tasks: (data?.completed_tasks || 0) + completedTasks,
    chats: (data?.chats || 0) + chats,
    challenges_completed: (data?.challenges_completed || 0) + challengesCompleted,
    mood_score: moodScore ?? data?.mood_score ?? null
  };

  const { error: upsertError } = await sb
    .from("daily_stats")
    .upsert(updated, { onConflict: "user_id,date" });

  if (upsertError) {
    console.error("‚ùå daily_stats upsert failed:", upsertError);
  } else {
    console.log("‚úÖ daily_stats updated:", updated);
  }
}

window.saveDailyStats = saveDailyStats;

// ================================
//  4) GENERIC HELPERS (PROFILE/SETTINGS)
// ================================
function logout() {
    sb.auth.signOut();
    window.location.href = "home.html";
}

function openProfile() {
    window.location.href = "about.html";
}

function changeAvatar() {
    window.location.href = "avatar.html";
}

function openSettings() {
    window.location.href = "settings.html";
}
document.addEventListener("DOMContentLoaded", () => {
  const profileBtn = document.getElementById("profileBtn");
  const profileMenu = document.getElementById("profileMenu");

  if (!profileBtn || !profileMenu) return;

  // Toggle menu on click
  profileBtn.addEventListener("click", (e) => {
    e.stopPropagation(); // üî• VERY IMPORTANT
    profileMenu.classList.toggle("show");
  });

  // Close when clicking outside
  document.addEventListener("click", () => {
    profileMenu.classList.remove("show");
  });

  // Prevent menu clicks from closing it
  profileMenu.addEventListener("click", (e) => {
    e.stopPropagation();
  });
});

window.logout = logout;
window.openProfile = openProfile;
window.changeAvatar = changeAvatar;
window.openSettings = openSettings;\n\n=====navbar.js=====\n\n
document.addEventListener("DOMContentLoaded", async () => {
    const nav = document.getElementById("navbar-right");
    if (!nav) return;

    // ‚úÖ Ensure sb exists
    if (!window.sb) {
        console.error("Supabase client (sb) not loaded");
        return;
    }

    const { data, error } = await sb.auth.getUser();
    const user = data?.user;

    nav.innerHTML = "";

    if (!user) {
        // üîê LOGGED OUT
        nav.innerHTML = `
            <a href="login.html" class="primary-btn"
               style="padding:8px 16px;font-size:13px;text-decoration:none;">
               Login
            </a>

            <div class="theme-toggle" onclick="toggleTheme()">üåô</div>
        `;
    } else {
        // ‚úÖ LOGGED IN
        const avatar =
            user.user_metadata?.avatar_url ||
            "../assets/avatars/default.png";

        nav.innerHTML = `
            <a href="dashboard.html" class="icon-btn-small" title="Dashboard">
                <i data-lucide="bar-chart-2" width="20"></i>
            </a>

            <div class="profile-wrapper">
                <img src="${avatar}" class="profile-avatar" id="profileAvatar">

                <div class="profile-menu">
                    <button onclick="location.href='profile.html'">üë§ Profile</button>
                    <button onclick="location.href='avatar.html'">üñº Change Avatar</button>
                    <button onclick="location.href='settings.html'">‚öô Settings</button>
                    <button onclick="logout()">üö™ Logout</button>
                </div>
            </div>

            <div class="theme-toggle" onclick="toggleTheme()">üåô</div>
        `;
    }

    lucide.createIcons();
});

// Logout
async function logout() {
    await sb.auth.signOut();
    location.href = "login.html";
}
